<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="ja" lang="ja">
  <head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <meta name="viewport"    content="width=device-width, initial-scale=1"/>
    <meta name="description" content="Rails ガイドは、Ruby on Rails Guides に基づいた Rails 4.2 対応のリファレンスガイドです。Rails 開発で生産性を向上する方法や、各部品がどのように連携しているかなどを体系的に理解する上で役に立ちます。" />
    <meta name="keywords"    content="Ruby Rails ガイド 体系的 入門 無料" />
    <meta name="author"      content="Ruby on Rails Community" />

    <meta property="fb:admins"      content="715330868" />
    <meta property="og:title"       content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:site_name"   content="Ruby on Rails ガイド：体系的に Rails を学ぼう"/>
    <meta property="og:image"       content="http://railsguides.jp/images/cover_for_facebook.png"/>
    <meta property="og:url"         content="http://railsguides.jp/" />
    <meta property="og:type"        content="article" />
    <meta property="og:description" content="Rails ガイドは、Ruby on Rails Guides に基づいた Rails 4.2 対応のリファレンスガイドです。Rails 開発で生産性を向上する方法や、各部品がどのように連携しているかなどを体系的に理解する上で役に立ちます。" />

    <meta name="twitter:card"  content="summary" />
    <meta name="twitter:site"  content="@RailsGuidesJP" />
    <meta name="twitter:title" content="Ruby on Rails ガイド：体系的に Rails を学ぼう" />
    <meta name="twitter:description" content="Rails ガイドは、Ruby on Rails Guides に基づいた Rails 4.2 対応のリファレンスガイドです。Rails 開発で生産性を向上する方法や、各部品がどのように連携しているかなどを体系的に理解する上で役に立ちます。" />
    <meta name="twitter:image" content="http://railsguides.jp/images/cover_for_twitter.png" />
    <meta name="twitter:url"   content="http://railsguides.jp/" />

    <title>Active Record Migrations — Rails ガイド</title>
    <link rel="stylesheet" type="text/css" href="stylesheets/style.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print" />

    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shCore.css" />
    <link rel="stylesheet" type="text/css" href="stylesheets/syntaxhighlighter/shThemeRailsGuides.css" />

    <link rel="stylesheet" type="text/css" href="stylesheets/fixes.css" />

    <link href="images/favicon.ico" rel="shortcut icon" type="image/x-icon" />

    <link rel="apple-touch-icon" sizes="57x57" href="images/favicons/apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="images/favicons/apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="images/favicons/apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="images/favicons/apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="images/favicons/apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="images/favicons/apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="images/favicons/apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="images/favicons/apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="images/favicons/apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192"  href="images/favicons/android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="images/favicons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="images/favicons/favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="images/favicons/favicon-16x16.png">
    <link rel="manifest" href="images/favicons/manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="images/favicons/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">

  </head>
<body class="guide">
  <div id="fb-root"></div>
  <script>(function(d, s, id) {
    var js, fjs = d.getElementsByTagName(s)[0];
    if (d.getElementById(id)) return;
    js = d.createElement(s); js.id = id;
    js.src = "//connect.facebook.net/en_US/sdk.js#xfbml=1&appId=614116885378153&version=v2.0";
    fjs.parentNode.insertBefore(js, fjs);
    }(document, 'script', 'facebook-jssdk'));</script>
  <div id="topNav">
    <div class="wrapper">
      <strong class="more-info-label">関連サイト: </strong>
      <span class="red-button more-info-button">関連URL</span>
      <ul class="more-info-links s-hidden">
        <li class="more-info"><a href="http://guides.rubyonrails.org/">原著 (英語)</a></li>
        <li class="more-info"><a href="https://github.com/yasslab/railsguides.jp">ソースコード (GitHub)</a></li>
        <li class="more-info"><a href="http://railstutorial.jp/">Rails チュートリアル</a></li>
      </ul>
    </div>
  </div>
  <div id="header">
    <div class="wrapper clearfix">
      <h1><a href="/" title="Return to home page">railsguides.jp</a></h1>
      <ul class="nav">
        <li><a class="nav-item" href="/">ホーム</a></li>
        <li class="guides-index guides-index-large">
          <a href="index.html" id="guidesMenu" class="guides-index-item nav-item">ガイド目次</a>
          <div id="guides" class="clearfix" style="display: none;">
            <hr />
              <dl class="L">
                <dt>はじめに</dt>
                <dd><a href="getting_started.html">Rails をはじめよう</a></dd>
                <dt>モデル</dt>
                <dd><a href="active_record_basics.html">Active Record の基礎</a></dd>
                <dd><a href="active_record_migrations.html">Active Record マイグレーション</a></dd>
                <dd><a href="active_record_validations.html">Active Record バリデーション</a></dd>
                <dd><a href="active_record_callbacks.html">Active Record コールバック</a></dd>
                <dd><a href="association_basics.html">Active Record の関連付け</a></dd>
                <dd><a href="active_record_querying.html">Active Record クエリインターフェイス</a></dd>
                <dd><a href="active_model_basics.html">Active Model の基礎</a></dd>
                <dt>ビュー</dt>
                <dd><a href="action_view_overview.html">Action View の概要</a></dd>
                <dd><a href="layouts_and_rendering.html">レイアウトとレンダリング</a></dd>
                <dd><a href="form_helpers.html">Action View フォームヘルパー</a></dd>
                <dt>コントローラ</dt>
                <dd><a href="action_controller_overview.html">Action Controller の概要</a></dd>
                <dd><a href="routing.html">Rails ルーティング</a></dd>
              </dl>
              <dl class="R">
                <dt>高度なトピック</dt>
                <dd><a href="active_support_core_extensions.html">Active Support コア拡張機能</a></dd>
                <dd><a href="i18n.html">Rails 国際化 (i18n) API</a></dd>
                <dd><a href="action_mailer_basics.html">Action Mailer の基礎</a></dd>
                <dd><a href="active_job_basics.html">Active Job の基礎</a></dd>
                <dd><a href="testing.html">Rails テスティングガイド</a></dd>
                <dd><a href="security.html">Rails セキュリティガイド</a></dd>
                <dd><a href="debugging_rails_applications.html">Rails アプリケーションのデバッグ</a></dd>
                <dd><a href="configuring.html">Rails アプリケーションを設定する</a></dd>
                <dd><a href="command_line.html">コマンドラインツールと Rake タスク</a></dd>
                <dd><a href="asset_pipeline.html">アセットパイプライン</a></dd>
                <dd><a href="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</a></dd>
                <dd><a href="engines.html">Rails エンジン入門</a></dd>
                <dd><a href="initialization.html">Rails の初期化プロセス</a></dd>
                <dd><a href="constant_autoloading_and_reloading.html">定数の自動読み込みと再読み込み</a></dd>
                <dt>Rails を拡張する</dt>
                <dd><a href="plugins.html">Rails プラグイン作成入門</a></dd>
                <dd><a href="rails_on_rack.html">Rails と Rack</a></dd>
                <dd><a href="generators.html">Rails ジェネレータとテンプレート入門</a></dd>
                <dt>Ruby on Rails に貢献する</dt>
                <dd><a href="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails [未着手]</a></dd>
                <dd><a href="api_documentation_guidelines.html">APIドキュメント作成ガイドライン</a></dd>
                <dd><a href="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</a></dd>
                <dt>メンテナンスポリシー</dt>
                <dd><a href="maintenance_policy.html">メンテナンスポリシー</a></dd>
                <dt>リリースノート</dt>
                <dd><a href="upgrading_ruby_on_rails.html">Rails アップグレードガイド</a></dd>
                <dd><a href="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</a></dd>
                <dd><a href="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</a></dd>
                <dd><a href="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</a></dd>
                <dd><a href="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</a></dd>
                <dd><a href="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</a></dd>
                <dd><a href="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</a></dd>
                <dd><a href="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</a></dd>
                <dd><a href="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</a></dd>
              </dl>
          </div>
        </li>
        <li><a class="nav-item" href="https://github.com/yasslab/railsguides.jp#readme">翻訳に貢献する</a></li>
        <li><a class="nav-item" href="credits.html">原著者</a></li>
        <li class="guides-index guides-index-small">
          <select class="guides-index-item nav-item">
            <option value="index.html">ガイド目次</option>
              <optgroup label="はじめに">
                  <option value="getting_started.html">Rails をはじめよう</option>
              </optgroup>
              <optgroup label="モデル">
                  <option value="active_record_basics.html">Active Record の基礎</option>
                  <option value="active_record_migrations.html">Active Record マイグレーション</option>
                  <option value="active_record_validations.html">Active Record バリデーション</option>
                  <option value="active_record_callbacks.html">Active Record コールバック</option>
                  <option value="association_basics.html">Active Record の関連付け</option>
                  <option value="active_record_querying.html">Active Record クエリインターフェイス</option>
                  <option value="active_model_basics.html">Active Model の基礎</option>
              </optgroup>
              <optgroup label="ビュー">
                  <option value="action_view_overview.html">Action View の概要</option>
                  <option value="layouts_and_rendering.html">レイアウトとレンダリング</option>
                  <option value="form_helpers.html">Action View フォームヘルパー</option>
              </optgroup>
              <optgroup label="コントローラ">
                  <option value="action_controller_overview.html">Action Controller の概要</option>
                  <option value="routing.html">Rails ルーティング</option>
              </optgroup>
              <optgroup label="高度なトピック">
                  <option value="active_support_core_extensions.html">Active Support コア拡張機能</option>
                  <option value="i18n.html">Rails 国際化 (i18n) API</option>
                  <option value="action_mailer_basics.html">Action Mailer の基礎</option>
                  <option value="active_job_basics.html">Active Job の基礎</option>
                  <option value="testing.html">Rails テスティングガイド</option>
                  <option value="security.html">Rails セキュリティガイド</option>
                  <option value="debugging_rails_applications.html">Rails アプリケーションのデバッグ</option>
                  <option value="configuring.html">Rails アプリケーションを設定する</option>
                  <option value="command_line.html">コマンドラインツールと Rake タスク</option>
                  <option value="asset_pipeline.html">アセットパイプライン</option>
                  <option value="working_with_javascript_in_rails.html">Rails で JavaScript を使用する</option>
                  <option value="engines.html">Rails エンジン入門</option>
                  <option value="initialization.html">Rails の初期化プロセス</option>
                  <option value="constant_autoloading_and_reloading.html">定数の自動読み込みと再読み込み</option>
              </optgroup>
              <optgroup label="Rails を拡張する">
                  <option value="plugins.html">Rails プラグイン作成入門</option>
                  <option value="rails_on_rack.html">Rails と Rack</option>
                  <option value="generators.html">Rails ジェネレータとテンプレート入門</option>
              </optgroup>
              <optgroup label="Ruby on Rails に貢献する">
                  <option value="contributing_to_ruby_on_rails.html">Contributing to Ruby on Rails [未着手]</option>
                  <option value="api_documentation_guidelines.html">APIドキュメント作成ガイドライン</option>
                  <option value="ruby_on_rails_guides_guidelines.html">Rails ガイドのガイドライン</option>
              </optgroup>
              <optgroup label="メンテナンスポリシー">
                  <option value="maintenance_policy.html">メンテナンスポリシー</option>
              </optgroup>
              <optgroup label="リリースノート">
                  <option value="upgrading_ruby_on_rails.html">Rails アップグレードガイド</option>
                  <option value="4_2_release_notes.html">Ruby on Rails 4.2 リリースノート</option>
                  <option value="4_1_release_notes.html">Ruby on Rails 4.1 リリースノート</option>
                  <option value="4_0_release_notes.html">Ruby on Rails 4.0 リリースノート</option>
                  <option value="3_2_release_notes.html">Ruby on Rails 3.2 Release Notes [未着手]</option>
                  <option value="3_1_release_notes.html">Ruby on Rails 3.1 Release Notes [未着手]</option>
                  <option value="3_0_release_notes.html">Ruby on Rails 3.0 Release Notes [未着手]</option>
                  <option value="2_3_release_notes.html">Ruby on Rails 2.3 Release Notes [未着手]</option>
                  <option value="2_2_release_notes.html">Ruby on Rails 2.2 Release Notes [未着手]</option>
              </optgroup>
          </select>
        </li>
      </ul>
      </div>
    </div>
  </div>
  <hr class="hide" />

  <div id="feature">
    <div class="wrapper">
      <h2>Active Record Migrations</h2><p>Migrations are a feature of Active Record that allows you to evolve your database schema over time. Rather than write schema modifications in pure SQL, migrations allow you to use an easy Ruby DSL to describe changes to your tables.</p><p>このガイドの内容:</p>
<ul>
<li>The generators you can use to create them.</li>
<li>The methods Active Record provides to manipulate your database.</li>
<li>The Rake tasks that manipulate migrations and your schema.</li>
<li>How migrations relate to <code>schema.rb</code>.</li>
</ul>

                <div id="subCol">
            <h3 class="chapter"><img src="images/chapters_icon.gif" alt="" />目次</h3>
            <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<ol class="chapters">
<li><a href="#migration-overview">Migration Overview</a></li>
<li>
<a href="#creating-a-migration">Creating a Migration</a>

<ul>
<li><a href="#creating-a-standalone-migration">Creating a Standalone Migration</a></li>
<li><a href="#model-generators">Model Generators</a></li>
<li><a href="#supported-type-modifiers">Supported Type Modifiers</a></li>
</ul>
</li>
<li>
<a href="#writing-a-migration">Writing a Migration</a>

<ul>
<li><a href="#creating-a-table">Creating a Table</a></li>
<li><a href="#creating-a-join-table">Creating a Join Table</a></li>
<li><a href="#changing-tables">Changing Tables</a></li>
<li><a href="#when-helpers-aren't-enough">When Helpers aren't Enough</a></li>
<li><a href="#using-the-change-method">Using the <code>change</code> Method</a></li>
<li><a href="#using-reversible">Using <code>reversible</code></a></li>
<li><a href="#using-the-up/down-methods">Using the <code>up</code>/<code>down</code> Methods</a></li>
<li><a href="#reverting-previous-migrations">Reverting Previous Migrations</a></li>
</ul>
</li>
<li>
<a href="#running-migrations">Running Migrations</a>

<ul>
<li><a href="#rolling-back">Rolling Back</a></li>
<li><a href="#setup-the-database">Setup the Database</a></li>
<li><a href="#resetting-the-database">Resetting the Database</a></li>
<li><a href="#running-specific-migrations">Running Specific Migrations</a></li>
<li><a href="#running-migrations-in-different-environments">Running Migrations in Different Environments</a></li>
<li><a href="#changing-the-output-of-running-migrations">Changing the Output of Running Migrations</a></li>
</ul>
</li>
<li><a href="#changing-existing-migrations">Changing Existing Migrations</a></li>
<li>
<a href="#schema-dumping-and-you">Schema Dumping and You</a>

<ul>
<li><a href="#what-are-schema-files-for?">What are Schema Files for?</a></li>
<li><a href="#types-of-schema-dumps">Types of Schema Dumps</a></li>
<li><a href="#schema-dumps-and-source-control">Schema Dumps and Source Control</a></li>
</ul>
</li>
<li><a href="#active-record-and-referential-integrity">Active Record and Referential Integrity</a></li>
<li><a href="#migrations-and-seed-data">Migrations and Seed Data</a></li>
</ol>
</body></html>

          </div>
</div>
  </div>

  <div id="container">
    <div class="wrapper">
      <div id="mainCol">
        <!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html><body>
<h3 id="migration-overview"><a href="#migration-overview">1 Migration Overview</a></h3>
<p>Migrations are a convenient way to <a href="http://en.wikipedia.org/wiki/Schema_migration">alter your database schema over time</a> in a consistent and easy way. They use a Ruby DSL so that you don't have to write SQL by hand, allowing your schema and changes to be database independent.</p>
<p>You can think of each migration as being a new 'version' of the database. A schema starts off with nothing in it, and each migration modifies it to add or remove tables, columns, or entries. Active Record knows how to update your schema along this timeline, bringing it from whatever point it is in the history to the latest version. Active Record will also update your <code>db/schema.rb</code> file to match the up-to-date structure of your database.</p>
<p>Here's an example of a migration:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class CreateProducts &lt; ActiveRecord::Migration
  def change
    create_table :products do |t|
      t.string :name
      t.text :description

      t.timestamps
  end
end 
  end

</pre>
</div>
<p>This migration adds a table called <code>products</code> with a string column called <code>name</code> and a text column called <code>description</code>. A primary key column called <code>id</code> will also be added implicitly, as it's the default primary key for all Active Record models. The <code>timestamps</code> macro adds two columns, <code>created_at</code> and <code>updated_at</code>. These special columns are automatically managed by Active Record if they exist.</p>
<p>Note that we define the change that we want to happen moving forward in time. Before this migration is run, there will be no table. After, the table will exist. Active Record knows how to reverse this migration as well: if we roll this migration back, it will remove the table.</p>
<p>On databases that support transactions with statements that change the schema, migrations are wrapped in a transaction. If the database does not support this then when a migration fails the parts of it that succeeded will not be rolled back. You will have to rollback the changes that were made by hand.</p>
<div class="note"><p>There are certain queries that can't run inside a transaction. If your adapter supports DDL transactions you can use <code>disable_ddl_transaction!</code> to disable them for a single migration.</p></div>
<p>If you wish for a migration to do something that Active Record doesn't know how to reverse, you can use <code>reversible</code>:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ChangeProductsPrice &lt; ActiveRecord::Migration
  def change
    reversible do |dir|
      change_table :products do |t|
        dir.up   { t.change :price, :string }
        dir.down { t.change :price, :integer }
  end
end 
end 
  end

</pre>
</div>
<p>Alternatively, you can use <code>up</code> and <code>down</code> instead of <code>change</code>:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ChangeProductsPrice &lt; ActiveRecord::Migration
  def up
    change_table :products do |t|
      t.change :price, :string
  end
  end

  def down
    change_table :products do |t|
      t.change :price, :integer
  end
end 
  end

</pre>
</div>
<h3 id="creating-a-migration"><a href="#creating-a-migration">2 Creating a Migration</a></h3>
<h4 id="creating-a-standalone-migration"><a href="#creating-a-standalone-migration">2.1 Creating a Standalone Migration</a></h4>
<p>Migrations are stored as files in the <code>db/migrate</code> directory, one for each migration class. The name of the file is of the form <code>YYYYMMDDHHMMSS_create_products.rb</code>, that is to say a UTC timestamp identifying the migration followed by an underscore followed by the name of the migration. The name of the migration class (CamelCased version)
should match the latter part of the file name. For example <code>20080906120000_create_products.rb</code> should define class <code>CreateProducts</code> and
<code>20080906120001_add_details_to_products.rb</code> should define <code>AddDetailsToProducts</code>. Rails uses this timestamp to determine which migration should be run and in what order, so if you're copying a migration from another application or generate a file yourself, be aware of its position in the order.</p>
<p>Of course, calculating timestamps is no fun, so Active Record provides a generator to handle making it for you:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails generate migration AddPartNumberToProducts

</pre>
</div>
<p>This will create an empty but appropriately named migration:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class AddPartNumberToProducts &lt; ActiveRecord::Migration
  def change
  end
  end

</pre>
</div>
<p>If the migration name is of the form "AddXXXToYYY" or "RemoveXXXFromYYY" and is followed by a list of column names and types then a migration containing the appropriate <code>add_column</code> and <code>remove_column</code> statements will be created.</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails generate migration AddPartNumberToProducts part_number:string

</pre>
</div>
<p>will generate</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class AddPartNumberToProducts &lt; ActiveRecord::Migration
  def change
    add_column :products, :part_number, :string
  end
  end

</pre>
</div>
<p>If you'd like to add an index on the new column, you can do that as well:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails generate migration AddPartNumberToProducts part_number:string:index

</pre>
</div>
<p>will generate</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class AddPartNumberToProducts &lt; ActiveRecord::Migration
  def change
    add_column :products, :part_number, :string
    add_index :products, :part_number
  end
  end

</pre>
</div>
<p>Similarly, you can generate a migration to remove a column from the command line:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails generate migration RemovePartNumberFromProducts part_number:string

</pre>
</div>
<p>以下ものを生成します：</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class RemovePartNumberFromProducts &lt; ActiveRecord::Migration
  def change
    remove_column :products, :part_number, :string
  end
  end

</pre>
</div>
<p>You are not limited to one magically generated column. 例：</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails generate migration AddDetailsToProducts part_number:string price:decimal

</pre>
</div>
<p>以下ものを生成します：</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class AddDetailsToProducts &lt; ActiveRecord::Migration
  def change
    add_column :products, :part_number, :string
    add_column :products, :price, :decimal
  end
  end

</pre>
</div>
<p>If the migration name is of the form "CreateXXX" and is followed by a list of column names and types then a migration creating the table XXX with the columns listed will be generated. 例：</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails generate migration CreateProducts name:string part_number:string

</pre>
</div>
<p>以下ものを生成します：</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class CreateProducts &lt; ActiveRecord::Migration
  def change
    create_table :products do |t|
      t.string :name
      t.string :part_number
  end
end 
  end

</pre>
</div>
<p>As always, what has been generated for you is just a starting point. You can add or remove from it as you see fit by editing the <code>db/migrate/YYYYMMDDHHMMSS_add_details_to_products.rb</code> file.</p>
<p>Also, the generator accepts column type as <code>references</code>(also available as <code>belongs_to</code>). たとえば：</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails generate migration AddUserRefToProducts user:references

</pre>
</div>
<p>以下ものを生成します：</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class AddUserRefToProducts &lt; ActiveRecord::Migration
  def change
    add_reference :products, :user, index: true
  end
  end

</pre>
</div>
<p>This migration will create a <code>user_id</code> column and appropriate index.</p>
<p>There is also a generator which will produce join tables if <code>JoinTable</code> is part of the name:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
rails g migration CreateJoinTableCustomerProduct customer product

</pre>
</div>
<p>will produce the following migration:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class CreateJoinTableCustomerProduct &lt; ActiveRecord::Migration
  def change
    create_join_table :customers, :products do |t|
      # t.index [:customer_id, :product_id]
      # t.index [:product_id, :customer_id]
  end
end 
  end

</pre>
</div>
<h4 id="model-generators"><a href="#model-generators">2.2 Model Generators</a></h4>
<p>The model and scaffold generators will create migrations appropriate for adding a new model. This migration will already contain instructions for creating the relevant table. If you tell Rails what columns you want, then statements for adding these columns will also be created. For example, running:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails generate model Product name:string description:text

</pre>
</div>
<p>will create a migration that looks like this</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class CreateProducts &lt; ActiveRecord::Migration
  def change
    create_table :products do |t|
      t.string :name
      t.text :description

      t.timestamps
  end
end 
  end

</pre>
</div>
<p>You can append as many column name/type pairs as you want.</p>
<h4 id="supported-type-modifiers"><a href="#supported-type-modifiers">2.3 Supported Type Modifiers</a></h4>
<p>You can also specify some options just after the field type between curly braces. You can use the following modifiers:</p>
<ul>
<li>
<code>limit</code>        Sets the maximum size of the <code>string/text/binary/integer</code> fields.</li>
<li>
<code>precision</code>    Defines the precision for the <code>decimal</code> fields, representing the total number of digits in the number.</li>
<li>
<code>scale</code>        Defines the scale for the <code>decimal</code> fields, representing the number of digits after the decimal point.</li>
<li>
<code>polymorphic</code>  Adds a <code>type</code> column for <code>belongs_to</code> associations.</li>
<li>
<code>null</code>         Allows or disallows <code>NULL</code> values in the column.</li>
</ul>
<p>For instance, running:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rails generate migration AddDetailsToProducts 'price:decimal{5,2}' supplier:references{polymorphic}

</pre>
</div>
<p>will produce a migration that looks like this</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class AddDetailsToProducts &lt; ActiveRecord::Migration
  def change
    add_column :products, :price, :decimal, precision: 5, scale: 2
    add_reference :products, :supplier, polymorphic: true, index: true
  end
  end

</pre>
</div>
<h3 id="writing-a-migration"><a href="#writing-a-migration">3 Writing a Migration</a></h3>
<p>Once you have created your migration using one of the generators it's time to get to work!</p>
<h4 id="creating-a-table"><a href="#creating-a-table">3.1 Creating a Table</a></h4>
<p>The <code>create_table</code> method is one of the most fundamental, but most of the time, will be generated for you from using a model or scaffold generator. A typical use would be</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
create_table :products do |t|
      t.string :name
  end

</pre>
</div>
<p>which creates a <code>products</code> table with a column called <code>name</code> (and as discussed below, an implicit <code>id</code> column).</p>
<p>By default, <code>create_table</code> will create a primary key called <code>id</code>. You can change the name of the primary key with the <code>:primary_key</code> option (don't forget to update the corresponding model) or, if you don't want a primary key at all, you can pass the option <code>id: false</code>. If you need to pass database specific options you can place an SQL fragment in the <code>:options</code> option. 例：</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
create_table :products, options: "ENGINE=BLACKHOLE" do |t|
  t.string :name, null: false
  end

</pre>
</div>
<p>will append <code>ENGINE=BLACKHOLE</code> to the SQL statement used to create the table (when using MySQL, the default is <code>ENGINE=InnoDB</code>).</p>
<h4 id="creating-a-join-table"><a href="#creating-a-join-table">3.2 Creating a Join Table</a></h4>
<p>Migration method <code>create_join_table</code> creates a HABTM join table. A typical use would be:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
create_join_table :products, :categories

</pre>
</div>
<p>which creates a <code>categories_products</code> table with two columns called <code>category_id</code> and <code>product_id</code>. These columns have the option <code>:null</code> set to <code>false</code> by default. This can be overridden by specifying the <code>:column_options</code> option.</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
create_join_table :products, :categories, column_options: {null: true}

</pre>
</div>
<p>will create the <code>product_id</code> and <code>category_id</code> with the <code>:null</code> option as <code>true</code>.</p>
<p>You can pass the option <code>:table_name</code> when you want to customize the table name. 例：</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
create_join_table :products, :categories, table_name: :categorization

</pre>
</div>
<p>will create a <code>categorization</code> table.</p>
<p><code>create_join_table</code> also accepts a block, which you can use to add indices (which are not created by default) or additional columns:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
create_join_table :products, :categories do |t|
  t.index :product_id
  t.index :category_id
  end

</pre>
</div>
<h4 id="changing-tables"><a href="#changing-tables">3.3 Changing Tables</a></h4>
<p>A close cousin of <code>create_table</code> is <code>change_table</code>, used for changing existing tables. It is used in a similar fashion to <code>create_table</code> but the object yielded to the block knows more tricks. 例：</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
change_table :products do |t|
  t.remove :description, :name
      t.string :part_number
  t.index :part_number
  t.rename :upccode, :upc_code
  end

</pre>
</div>
<p>removes the <code>description</code> and <code>name</code> columns, creates a <code>part_number</code> string column and adds an index on it. Finally it renames the <code>upccode</code> column.</p>
<h4 id="when-helpers-aren't-enough"><a href="#when-helpers-aren't-enough">3.4 When Helpers aren't Enough</a></h4>
<p>If the helpers provided by Active Record aren't enough you can use the <code>execute</code> method to execute arbitrary SQL:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
Product.connection.execute('UPDATE `products` SET `price`=`free` WHERE 1')

</pre>
</div>
<p>For more details and examples of individual methods, check the API documentation.
In particular the documentation for <a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/SchemaStatements.html"><code>ActiveRecord::ConnectionAdapters::SchemaStatements</code></a> (which provides the methods available in the <code>change</code>, <code>up</code> and <code>down</code> methods), <a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/TableDefinition.html"><code>ActiveRecord::ConnectionAdapters::TableDefinition</code></a> (which provides the methods available on the object yielded by <code>create_table</code>) and <a href="http://api.rubyonrails.org/classes/ActiveRecord/ConnectionAdapters/Table.html"><code>ActiveRecord::ConnectionAdapters::Table</code></a> (which provides the methods available on the object yielded by <code>change_table</code>).</p>
<h4 id="using-the-change-method"><a href="#using-the-change-method">3.5 Using the <code>change</code> Method</a></h4>
<p>The <code>change</code> method is the primary way of writing migrations. It works for the majority of cases, where Active Record knows how to reverse the migration automatically. Currently, the <code>change</code> method supports only these migration definitions:</p>
<ul>
<li><code>add_column</code></li>
<li><code>add_index</code></li>
<li><code>add_reference</code></li>
<li><code>add_timestamps</code></li>
<li><code>create_table</code></li>
<li><code>create_join_table</code></li>
<li>
<code>drop_table</code> (must supply a block)</li>
<li>
<code>drop_join_table</code> (must supply a block)</li>
<li><code>remove_timestamps</code></li>
<li><code>rename_column</code></li>
<li><code>rename_index</code></li>
<li><code>remove_reference</code></li>
<li><code>rename_table</code></li>
</ul>
<p><code>change_table</code> is also reversible, as long as the block does not call <code>change</code>, <code>change_default</code> or <code>remove</code>.</p>
<p>If you're going to need to use any other methods, you should use <code>reversible</code> or write the <code>up</code> and <code>down</code> methods instead of using the <code>change</code> method.</p>
<h4 id="using-reversible"><a href="#using-reversible">3.6 Using <code>reversible</code></a></h4>
<p>Complex migrations may require processing that Active Record doesn't know how to reverse. You can use <code>reversible</code> to specify what to do when running a migration what else to do when reverting it. 例：</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ExampleMigration &lt; ActiveRecord::Migration
  def change
    create_table :products do |t|
      t.references :category
  end

    reversible do |dir|
      dir.up do
        #add a foreign key
        execute &lt;&lt;-SQL
          ALTER TABLE products
            ADD CONSTRAINT fk_products_categories
            FOREIGN KEY (category_id)
            REFERENCES categories(id)
        SQL
  end
      dir.down do
        execute &lt;&lt;-SQL
          ALTER TABLE products
            DROP FOREIGN KEY fk_products_categories
        SQL
  end
  end

    add_column :users, :home_page_url, :string
    rename_column :users, :email, :email_address
  end
  end

</pre>
</div>
<p>Using <code>reversible</code> will ensure that the instructions are executed in the right order too. If the previous example migration is reverted, the <code>down</code> block will be run after the <code>home_page_url</code> column is removed and right before the table <code>products</code> is dropped.</p>
<p>Sometimes your migration will do something which is just plain irreversible; for example, it might destroy some data. In such cases, you can raise <code>ActiveRecord::IrreversibleMigration</code> in your <code>down</code> block. If someone tries to revert your migration, an error message will be displayed saying that it can't be done.</p>
<h4 id="using-the-up/down-methods"><a href="#using-the-up/down-methods">3.7 Using the <code>up</code>/<code>down</code> Methods</a></h4>
<p>You can also use the old style of migration using <code>up</code> and <code>down</code> methods instead of the <code>change</code> method. The <code>up</code> method should describe the transformation you'd like to make to your schema, and the <code>down</code> method of your migration should revert the transformations done by the <code>up</code> method. In other words, the database schema should be unchanged if you do an <code>up</code> followed by a <code>down</code>. For example, if you create a table in the <code>up</code> method, you should drop it in the <code>down</code> method. It is wise to reverse the transformations in precisely the reverse order they were made in the <code>up</code> method. The example in the <code>reversible</code> section is equivalent to:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class ExampleMigration &lt; ActiveRecord::Migration
  def up
    create_table :products do |t|
      t.references :category
  end

    # add a foreign key
    execute &lt;&lt;-SQL
      ALTER TABLE products
        ADD CONSTRAINT fk_products_categories
        FOREIGN KEY (category_id)
        REFERENCES categories(id)
    SQL

    add_column :users, :home_page_url, :string
    rename_column :users, :email, :email_address
  end

  def down
    rename_column :users, :email_address, :email
    remove_column :users, :home_page_url

    execute &lt;&lt;-SQL
      ALTER TABLE products
        DROP FOREIGN KEY fk_products_categories
    SQL

    drop_table :products
  end
  end

</pre>
</div>
<p>If your migration is irreversible, you should raise <code>ActiveRecord::IrreversibleMigration</code> from your <code>down</code> method. If someone tries to revert your migration, an error message will be displayed saying that it can't be done.</p>
<h4 id="reverting-previous-migrations"><a href="#reverting-previous-migrations">3.8 Reverting Previous Migrations</a></h4>
<p>You can use Active Record's ability to rollback migrations using the <code>revert</code> method:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
require_relative '2012121212_example_migration'

class FixupExampleMigration &lt; ActiveRecord::Migration
  def change
    revert ExampleMigration

    create_table(:apples) do |t|
      t.string :variety
  end
end 
  end

</pre>
</div>
<p>The <code>revert</code> method also accepts a block of instructions to reverse.
This could be useful to revert selected parts of previous migrations. For example, let's imagine that <code>ExampleMigration</code> is committed and it is later decided it would be best to serialize the product list instead.
One could write:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class SerializeProductListMigration &lt; ActiveRecord::Migration
  def change
    add_column :categories, :product_list

    reversible do |dir|
      dir.up do
        # transfer data from Products to Category#product_list
  end
      dir.down do
        # create Products from Category#product_list
  end
  end

    revert do
      # copy-pasted code from ExampleMigration
      create_table :products do |t|
        t.references :category
  end

      reversible do |dir|
        dir.up do
          #add a foreign key
          execute &lt;&lt;-SQL
            ALTER TABLE products
              ADD CONSTRAINT fk_products_categories
              FOREIGN KEY (category_id)
              REFERENCES categories(id)
          SQL
  end
        dir.down do
          execute &lt;&lt;-SQL
            ALTER TABLE products
              DROP FOREIGN KEY fk_products_categories
          SQL
  end
  end

      # The rest of the migration was ok
  end
end 
  end

</pre>
</div>
<p>The same migration could also have been written without using <code>revert</code> but this would have involved a few more steps: reversing the order of <code>create_table</code> and <code>reversible</code>, replacing <code>create_table</code> by <code>drop_table</code>, and finally replacing <code>up</code> by <code>down</code> and vice-versa.
This is all taken care of by <code>revert</code>.</p>
<h3 id="running-migrations"><a href="#running-migrations">4 Running Migrations</a></h3>
<p>Rails provides a set of Rake tasks to run certain sets of migrations.</p>
<p>The very first migration related Rake task you will use will probably be <code>rake db:migrate</code>. In its most basic form it just runs the <code>change</code> or <code>up</code> method for all the migrations that have not yet been run. If there are no such migrations, it exits. It will run these migrations in order based on the date of the migration.</p>
<p>Note that running the <code>db:migrate</code> task also invokes the <code>db:schema:dump</code> task, which will update your <code>db/schema.rb</code> file to match the structure of your database.</p>
<p>If you specify a target version, Active Record will run the required migrations (change, up, down) until it has reached the specified version. The version is the numerical prefix on the migration's filename. For example, to migrate to version 20080906120000 run:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rake db:migrate VERSION=20080906120000

</pre>
</div>
<p>If version 20080906120000 is greater than the current version (i.e., it is migrating upwards), this will run the <code>change</code> (or <code>up</code>) method
on all migrations up to and including 20080906120000, and will not execute any later migrations. If migrating downwards, this will run the <code>down</code> method on all the migrations down to, but not including, 20080906120000.</p>
<h4 id="rolling-back"><a href="#rolling-back">4.1 Rolling Back</a></h4>
<p>A common task is to rollback the last migration. For example, if you made a mistake in it and wish to correct it. Rather than tracking down the version number associated with the previous migration you can run:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rake db:rollback

</pre>
</div>
<p>This will rollback the latest migration, either by reverting the <code>change</code> method or by running the <code>down</code> method. If you need to undo several migrations you can provide a <code>STEP</code> parameter:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rake db:rollback STEP=3

</pre>
</div>
<p>will revert the last 3 migrations.</p>
<p>The <code>db:migrate:redo</code> task is a shortcut for doing a rollback and then migrating back up again. As with the <code>db:rollback</code> task, you can use the <code>STEP</code> parameter if you need to go more than one version back, for example:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rake db:migrate:redo STEP=3

</pre>
</div>
<p>Neither of these Rake tasks do anything you could not do with <code>db:migrate</code>. They are simply more convenient, since you do not need to explicitly specify the version to migrate to.</p>
<h4 id="setup-the-database"><a href="#setup-the-database">4.2 Setup the Database</a></h4>
<p>The <code>rake db:setup</code> task will create the database, load the schema and initialize it with the seed data.</p>
<h4 id="resetting-the-database"><a href="#resetting-the-database">4.3 Resetting the Database</a></h4>
<p>The <code>rake db:reset</code> task will drop the database and set it up again. This is functionally equivalent to <code>rake db:drop db:setup</code>.</p>
<div class="note"><p>This is not the same as running all the migrations. It will only use the contents of the current <code>schema.rb</code> file. If a migration can't be rolled back, <code>rake db:reset</code> may not help you. To find out more about dumping the schema see <a href="#schema-dumping-and-you">Schema Dumping and You</a> section.</p></div>
<h4 id="running-specific-migrations"><a href="#running-specific-migrations">4.4 Running Specific Migrations</a></h4>
<p>If you need to run a specific migration up or down, the <code>db:migrate:up</code> and <code>db:migrate:down</code> tasks will do that. Just specify the appropriate version and the corresponding migration will have its <code>change</code>, <code>up</code> or <code>down</code> method invoked, for example:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rake db:migrate:up VERSION=20080906120000

</pre>
</div>
<p>will run the 20080906120000 migration by running the <code>change</code> method (or the <code>up</code> method). This task will first check whether the migration is already performed and will do nothing if Active Record believes that it has already been run.</p>
<h4 id="running-migrations-in-different-environments"><a href="#running-migrations-in-different-environments">4.5 Running Migrations in Different Environments</a></h4>
<p>By default running <code>rake db:migrate</code> will run in the <code>development</code> environment. To run migrations against another environment you can specify it using the <code>RAILS_ENV</code> environment variable while running the command. For example to run migrations against the <code>test</code> environment you could run:</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
$ rake db:migrate RAILS_ENV=test

</pre>
</div>
<h4 id="changing-the-output-of-running-migrations"><a href="#changing-the-output-of-running-migrations">4.6 Changing the Output of Running Migrations</a></h4>
<p>By default migrations tell you exactly what they're doing and how long it took. A migration creating a table and adding an index might produce output like this</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
==  CreateProducts: migrating =================================================
-- create_table(:products)
   -&gt; 0.0028s
==  CreateProducts: migrated (0.0028s) ========================================

</pre>
</div>
<p>Several methods are provided in migrations that allow you to control all this:</p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Purpose</th>
</tr>
</thead>
<tbody>
<tr>
<td>suppress_messages</td>
<td>Takes a block as an argument and suppresses any output generated by the block.</td>
</tr>
<tr>
<td>say</td>
<td>Takes a message argument and outputs it as is. A second boolean argument can be passed to specify whether to indent or not.</td>
</tr>
<tr>
<td>say_with_time</td>
<td>Outputs text along with how long it took to run its block. If the block returns an integer it assumes it is the number of rows affected.</td>
</tr>
</tbody>
</table>
<p>For example, this migration:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class CreateProducts &lt; ActiveRecord::Migration
  def change
    suppress_messages do
      create_table :products do |t|
      t.string :name
      t.text :description
      t.timestamps
  end
  end

    say "Created a table"

    suppress_messages {add_index :products, :name}
    say "and an index!", true

    say_with_time 'Waiting for a while' do
      sleep 10
250
  end
end 
  end

</pre>
</div>
<p>generates the following output</p>
<div class="code_container">
<pre class="brush: plain; gutter: false; toolbar: false">
==  CreateProducts: migrating =================================================
-- Created a table
   -&gt; and an index!
-- Waiting for a while
   -&gt; 10.0013s
   -&gt; 250 rows
==  CreateProducts: migrated (10.0054s) =======================================

</pre>
</div>
<p>If you want Active Record to not output anything, then running <code>rake db:migrate VERBOSE=false</code> will suppress all output.</p>
<h3 id="changing-existing-migrations"><a href="#changing-existing-migrations">5 Changing Existing Migrations</a></h3>
<p>Occasionally you will make a mistake when writing a migration. If you have already run the migration then you cannot just edit the migration and run the migration again: Rails thinks it has already run the migration and so will do nothing when you run <code>rake db:migrate</code>. You must rollback the migration (for example with <code>rake db:rollback</code>), edit your migration and then run <code>rake db:migrate</code> to run the corrected version.</p>
<p>In general, editing existing migrations is not a good idea. You will be creating extra work for yourself and your co-workers and cause major headaches if the existing version of the migration has already been run on production machines. Instead, you should write a new migration that performs the changes you require. Editing a freshly generated migration that has not yet been committed to source control (or, more generally, which has not been propagated beyond your development machine) is relatively harmless.</p>
<p>The <code>revert</code> method can be helpful when writing a new migration to undo previous migrations in whole or in part (see <a href="#reverting-previous-migrations">Reverting Previous Migrations</a> above).</p>
<h3 id="schema-dumping-and-you"><a href="#schema-dumping-and-you">6 Schema Dumping and You</a></h3>
<h4 id="what-are-schema-files-for?"><a href="#what-are-schema-files-for?">6.1 What are Schema Files for?</a></h4>
<p>Migrations, mighty as they may be, are not the authoritative source for your database schema. That role falls to either <code>db/schema.rb</code> or an SQL file which Active Record generates by examining the database. They are not designed to be edited, they just represent the current state of the database.</p>
<p>There is no need (and it is error prone) to deploy a new instance of an app by replaying the entire migration history. It is much simpler and faster to just load into the database a description of the current schema.</p>
<p>For example, this is how the test database is created: the current development database is dumped (either to <code>db/schema.rb</code> or <code>db/structure.sql</code>) and then loaded into the test database.</p>
<p>Schema files are also useful if you want a quick look at what attributes an Active Record object has. This information is not in the model's code and is frequently spread across several migrations, but the information is nicely summed up in the schema file. The <a href="https://github.com/ctran/annotate_models">annotate_models</a> gem automatically adds and updates comments at the top of each model summarizing the schema if you desire that functionality.</p>
<h4 id="types-of-schema-dumps"><a href="#types-of-schema-dumps">6.2 Types of Schema Dumps</a></h4>
<p>There are two ways to dump the schema. This is set in <code>config/application.rb</code> by the <code>config.active_record.schema_format</code> setting, which may be either <code>:sql</code> or <code>:ruby</code>.</p>
<p>If <code>:ruby</code> is selected then the schema is stored in <code>db/schema.rb</code>. If you look at this file you'll find that it looks an awful lot like one very big migration:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
ActiveRecord::Schema.define(version: 20080906171750) do
  create_table "authors", force: true do |t|
    t.string   "name"
    t.datetime "created_at"
    t.datetime "updated_at"
  end

  create_table "products", force: true do |t|
    t.string   "name"
    t.text "description"
    t.datetime "created_at"
    t.datetime "updated_at"
    t.string "part_number"
  end
  end

</pre>
</div>
<p>In many ways this is exactly what it is. This file is created by inspecting the database and expressing its structure using <code>create_table</code>, <code>add_index</code>, and so on. Because this is database-independent, it could be loaded into any database that Active Record supports. This could be very useful if you were to distribute an application that is able to run against multiple databases.</p>
<p>There is however a trade-off: <code>db/schema.rb</code> cannot express database specific items such as foreign key constraints, triggers, or stored procedures. While in a migration you can execute custom SQL statements, the schema dumper cannot reconstitute those statements from the database. If you are using features like this, then you should set the schema format to <code>:sql</code>.</p>
<p>Instead of using Active Record's schema dumper, the database's structure will be dumped using a tool specific to the database (via the <code>db:structure:dump</code> Rake task) into <code>db/structure.sql</code>. For example, for PostgreSQL, the <code>pg_dump</code> utility is used. For MySQL, this file will contain the output of a<code>SHOW CREATE TABLE</code> for the various tables.</p>
<p>Loading these schemas is simply a question of executing the SQL statements they contain. By definition, this will create a perfect copy of the database's structure. Using the <code>:sql</code> schema format will, however, prevent loading the schema into a RDBMS other than the one used to create it.</p>
<h4 id="schema-dumps-and-source-control"><a href="#schema-dumps-and-source-control">6.3 Schema Dumps and Source Control</a></h4>
<p>Because schema dumps are the authoritative source for your database schema, it is strongly recommended that you check them into source control.</p>
<h3 id="active-record-and-referential-integrity"><a href="#active-record-and-referential-integrity">7 Active Record and Referential Integrity</a></h3>
<p>The Active Record way claims that intelligence belongs in your models, not in the database. As such, features such as triggers or foreign key constraints, which push some of that intelligence back into the database, are not heavily used.</p>
<p>Validations such as <code>validates :foreign_key, uniqueness: true</code> are one way in which models can enforce data integrity. The <code>:dependent</code> option on associations allows models to automatically destroy child objects when the parent is destroyed. Like anything which operates at the application level, these cannot guarantee referential integrity and so some people augment them with foreign key constraints in the database.</p>
<p>Although Active Record does not provide any tools for working directly with such features, the <code>execute</code> method can be used to execute arbitrary SQL. You can also use a gem like <a href="https://github.com/matthuhiggins/foreigner">foreigner</a> which adds foreign key support to Active Record (including support for dumping foreign keys in <code>db/schema.rb</code>).</p>
<h3 id="migrations-and-seed-data"><a href="#migrations-and-seed-data">8 Migrations and Seed Data</a></h3>
<p>Some people use migrations to add data to the database:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
class AddInitialProducts &lt; ActiveRecord::Migration
  def up
    5.times do |i|
      Product.create(name: "Product ##{i}", description: "A product.")
  end
  end

  def down
    Product.delete_all
  end
  end

</pre>
</div>
<p>However, Rails has a 'seeds' feature that should be used for seeding a database with initial data. It's a really simple feature: just fill up <code>db/seeds.rb</code> with some Ruby code, and run <code>rake db:seed</code>:</p>
<div class="code_container">
<pre class="brush: ruby; gutter: false; toolbar: false">
5.times do |i|
  Product.create(name: "Product ##{i}", description: "A product.")
  end

</pre>
</div>
<p>This is generally a much cleaner way to set up the database of a blank application.</p>
</body></html>

        
        <h3>フィードバックについて</h3>
        <p>
          本ガイドの訳文およびソースコードは、GitHub上の <a href="https://github.com/yasslab/railsguides.jp">yasslab/railsguides.jp</a> で管理・公開されております。
	  本ガイドを読んで、誤字・脱字・誤訳などを見かけましたら、上記リポジトリにてお気軽に <a href="https://github.com/yasslab/railsguides.jp/issues">Issue</a> を出して頂けると大変嬉しいです。また、「Pull Request を送りたい!」という場合には、<a href="ruby_on_rails_guides_guidelines.html">Ruby on Railsガイドのガイドライン</a>と、<a href="https://github.com/yasslab/railsguides.jp#%E7%BF%BB%E8%A8%B3%E3%81%AE%E6%B5%81%E3%82%8C">README</a>に記載されている「翻訳の流れ」をご参考にしてください。
	</p>
	<p>
	  なお、原著レベルでの間違いを見つけましたら、原著へのフィードバック方法 (<a href="http://edgeguides.rubyonrails.org/contributing_to_ruby_on_rails.html#contributing-to-the-rails-documentation">documentation contributions</a>) をご参考にしてください。
        </p>
        <p>
	  本ガイドの品質向上に向けて、皆さまのご協力が得られれば幸いです。よろしくお願い致します。
        </p>
      </div>
    </div>
  </div>

  <hr class="hide" />
  <div id="footer">
    <div class="wrapper">
      <ol class="snsb" style="margin-left: 13px">
	<li><a href="http://www.railscp.org/text/" target="_blank"><img src="images/railscp_logo.png" width="150px"/></a></li>
      </ol>
      <ol class="snsb" style="margin-left: 13px">
	<li><iframe src="http://ghbtns.com/github-btn.html?user=yasslab&repo=railsguides.jp&type=watch&count=true" allowtransparency="true" frameborder="0" scrolling="0" width="80" height="20"></iframe></li>
	<li><a href="http://b.hatena.ne.jp/entry/railsguides.jp" class="hatena-bookmark-button" data-hatena-bookmark-title="Ruby on Rails ガイド：体系的に Rails を学ぼう (Rails 4.2 対応)" data-hatena-bookmark-layout="standard-balloon" data-hatena-bookmark-lang="ja" title="このエントリーをはてなブックマークに追加"><img src="http://b.st-hatena.com/images/entry-button/button-only@2x.png" alt="このエントリーをはてなブックマークに追加" width="20" height="20" style="border: none;" /></a><script type="text/javascript" src="http://b.st-hatena.com/js/bookmark_button.js" charset="utf-8" async="async"></script></li>
	<li><div class="fb-like" data-href="http://railsguides.jp/" data-layout="button_count" data-action="like" data-show-faces="true" data-share="true"></div></li>
	<li><a href="https://twitter.com/share" class="twitter-share-button" data-url="http://railsguides.jp/" data-text="Ruby on Rails ガイド：体系的に Rails を学ぼう (Rails 4.2 対応)" data-lang="ja" data-hashtags="Railsガイド" width="100">ツイート</a><script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script></li>
      </ol>
      <ol class="snsb" style="margin-left: 13px">
	<li>本ガイドは<a href="https://creativecommons.org/licenses/by-sa/4.0/deed.ja">クリエイティブ・コモンズ 表示-継承 4.0 国際</a> (CC BY-SA 4.0) ライセンスに基づいて公開されています。</li>
	<li>「Rails」および「Ruby on Rails」という名称、そして Rails のロゴは、David Heinemeier Hansson による登録商標で、すべての権利を有しています。</li>
      </ol>
    </div>
  </div>
</h5>
  <script type="text/javascript" src="javascripts/jquery.min.js"></script>
  <script type="text/javascript" src="javascripts/responsive-tables.js"></script>
  <script type="text/javascript" src="javascripts/guides.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shCore.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushRuby.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushXml.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushSql.js"></script>
  <script type="text/javascript" src="javascripts/syntaxhighlighter/shBrushPlain.js"></script>
  <script type="text/javascript">
    SyntaxHighlighter.all();
    $(guidesIndex.bind);
  </script>
  <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    
    ga('create', 'UA-50163209-4', 'auto');
    ga('send', 'pageview');
  </script>
</body>
</html>
